


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>科室信息管理</title>
    <!--框架必需start-->
    <script type="text/javascript" src="/assets/libs/js/jquery.js"></script>
    <script type="text/javascript" src="/assets/libs/js/language/cn.js"></script>
    <script type="text/javascript" src="/assets/libs/js/framework.js"></script>
    <link href="/assets/libs/css/import_basic.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" id="skin" prepath="../" scrollery="false" />
    <link rel="stylesheet" type="text/css" id="customSkin" />
  
    <!--框架必需end-->
    <!--树组件start -->
    <script type="text/javascript" src="/assets/libs/js/tree/ztree/ztree.js"></script>
    <link href="/assets/libs/js/tree/ztree/ztree.css" rel="stylesheet" type="text/css" />
    <!--树组件end -->
    <!-- 树形下拉框start -->
    <script type="text/javascript" src="/assets/libs/js/form/selectTree.js"></script>
    <!-- 树形下拉框end -->
    <!-- 表单验证start -->
    <script src="/assets/libs/js/form/validationRule.js" type="text/javascript"></script>
    <script src="/assets/libs/js/form/validation.js" type="text/javascript"></script>
    <!-- 表单验证end -->
</head>
<body>

<div class="box1" panelwidth="700" style="float: right; position: absolute; left: 350px;">
    <form method="post" action="/Departments" id="Form2">
        <table class="tableStyle" formmode="line">
            <tr>
                <td>
                    科室名称：
                </td>
                <td>
                    <input name="selectname" type="text" id="selectname" style="width: 200px;" class="validate[required,length[0,30]]" /><span
                        class="star">*</span>
                    <input type="hidden" name="selectId" id="selectId" value="0" />
                    <input type="hidden" name="hdselectname" id="hdselectname" />
                    <input type="hidden" name="hdOrd" id="hdOrd" value="0" />
                    <input type="hidden" name="hdRemark" id="hdRemark" />
                    <input type="hidden" name="ParentId" id="ParentId" value="0" />
                    <input type="hidden" name="ManagerID" id="ManagerID" />
                    <input type="hidden" name="EngineerID" id="EngineerID" />
                </td>
                <td>
                    备注：
                </td>
                <td colspan="3">

                    <input name="Remark" type="text" id="Remark" style="width: 200px;" />
                </td>
            </tr>

            <tr>
                <td>
                    显示序列：
                </td>
                <td >
                    <input name="Ord" type="text" id="Ord" style="width: 200px;" class=" validate[required,custom[onlyNumber]] float_left" />
                </td>
                <td>护士站电话：</td>
                <td>
                    <input name="txtNurseStationTel" type="text" id="txtNurseStationTel" style="width: 200px;" />
                </td>
            </tr>
            <tr>
                <td>
                    维保工程师：
                </td>
                <td>
                    <div class="selectTree"  selectedvalue="" id="EngineerIDs" url="/users/engineer/3001">
                    </div>
                </td>
                <td>

                    科室负责人：
                </td>
                <td>
                    <div class="selectTree " selectedvalue="" id="ManagerIDs" url="">
                    </div>

                </td>
            </tr>
            <tr>
                <td align="center" colspan="4">
                    <input type="button"  value="保存" onclick="Save()" />
                    <input type="button" value="重置" onclick="Set()" />
                    <input type="hidden" name="hdEngineerID" id="hdEngineerID" />
                </td>
            </tr>
        </table>
    </form>
</div>
                <div class="box1" panelwidth="300">
                    <div id="leftCon" position="left" style="" paneltitle="科室机构树">
                        <div class="orgTreeContainer">
                            <ul id="tree-1" class="ztree">
                            </ul>
                        </div>
                    </div>
                </div>


    <script type="text/javascript">
        //设定不可编辑的节点id
        var noeditArray = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17"];

        //树的设置
        var setting1 = {
            view: {
                addHoverDom: addHoverDom,
                removeHoverDom: removeHoverDom,
                selectedMulti: false
            },
            edit: {
                enable: true,
                renameTitle: "修改",
                removeTitle: "删除"
            },
            callback: {
                onClick: onClick1,
                //不允许拖拽
                beforeDrag: beforeDrag1,
                //修改前确认
                beforeEditName: beforeEditName1,
                //修改完时的处理
                beforeRename: beforeRename1,
                //修改成功后处理
                onRename: onRename1,
                //删除前确认
                beforeRemove: beforeRemove1
            }
        };

        //定义树节点初始数据
        var zNodes1 = [
		{ id: "0", parentId: "-1", name: "科室树", open: true, icon: "/assets/libs/icons/home.gif" }
	];

        //初始化函数
        function initComplete() {
            //初始化树
            getOrgTreeData();

            $("#ManagerIDs").bind("change", function () {
                $("#ManagerID").val($(this).attr("relValue"));
            })
            $("#EngineerIDs").bind("change", function () {
                $("#EngineerID").val($(this).attr("relValue"));
                $("#hdEngineerID").val($(this).attr("relValue"));
            })

        }

        //获取数据初始化树
        function getOrgTreeData() {
            $.ajax({
//            type: 'POST',
//                url: '../Handler/Departments.ashx',

                type: 'GET',
                url: '/departments/tree',
                dataType: 'json',
                data: { Command: "List", Type: 1 },
                success: function (result) {
                    var nodes = zNodes1.concat(result.treeNodes);
                    $.fn.zTree.init($("#tree-1"), setting1, nodes);
                },
                error: function (a) {
                    top.Dialog.alert("OrgTree:访问服务器端出错！");
                    //alert("OrgTree:访问服务器端出错!");
                },

                dataType: 'json'

            });
        }

        //获取树对象
        function getTree() {
            return $.fn.zTree.getZTreeObj("tree-1");
        }

        //点击树节点
        function onClick1(event, treeId, treeNode, clickFlag) {
            //top.Dialog.alert(treeNode.id);
            if (treeNode.id == 30001 || treeNode.id == 0) {
                top.Dialog.alert("此节点无法编辑！");
            }
            else {
                //设置表单的值
                setForm(treeNode.name, treeNode.EngineerID);
                $("#selectId").val(treeNode.id);
                $("#ManagerID").val(treeNode.ManagerID);
                $("#EngineerID").val(treeNode.EngineerID);
                $("#Remark").val(treeNode.Remark);
                $("#ParentId").val(treeNode.parentId);
                $("#txtNurseStationTel").val(treeNode.NurseStationTel);
                $("#Ord").val(treeNode.Ord);

                //获取远程数据
//                $.post("../Handler/Users.ashx?type=GetUserSelectTree&ParentID=" + treeNode.id, {}, function (result) {

                $.post("/users/usertree"+ treeNode.id, {}, function (result) {
                    //赋给data属性
                    $("#ManagerIDs").data("data", result);
                    //刷新树形下拉框
                    $("#ManagerIDs").render();
                }, "json");
                $("#ManagerIDs").setValue(treeNode.ManagerID == 0 ? "" : treeNode.ManagerID);
                $("#EngineerIDs").setValue(treeNode.EngineerID == 0 ? "" : treeNode.EngineerID);

                // 记录信息(重置)
                $("#hdselectname").val(treeNode.name);
                $("#hdOrd").val(treeNode.Ord);
                $("#hdRemark").val(treeNode.Remark);
            }
        }

        //不允许拖拽
        function beforeDrag1(treeId, treeNodes) {
            return false;
        }

        //确认是否进入编辑状态
        function beforeEditName1(treeId, treeNode) {
            if (treeNode.id == 0 || treeNode.id == 30001) {
                top.Dialog.alert("此点不能修改！");
                return false;
            }
            else if (getPosition(treeNode.id, noeditArray) != -1) {
                //top.Dialog.alert("为保证数据的完整性，由管理员添加的数据无法修改或删除。可以为新添加的数据来修改和删除。");
                //return false;
            }
            var zTree = getTree();
            //选中该节点
            zTree.selectNode(treeNode);
            //设置表单的值
            setForm(treeNode.name, treeNode.EngineerID);
            $("#selectId").val(treeNode.id);
            $("#ManagerID").val(treeNode.ManagerID);
            $("#Remark").val(treeNode.Remark);
            $("#ParentId").val(treeNode.parentId);
            zTree.editName(treeNode);
            return true;
        }

        //修改完时处理 不进行后台数据处理
        function beforeRename1(treeId, treeNode, newName) {
            if (newName.length == 0) {
                top.Dialog.alert("节点名称不能为空.");
                getOrgTreeData();
                //var zTree = getTree();
                //setTimeout(function(){zTree.editName(treeNode)}, 10);
                return false;
            }
            return true;
        }
        //修改成功后处理
        function onRename1(event, treeId, treeNode) {
            if (treeNode.existed) {
                updateNode(treeNode);
            } else {
                addNode(treeNode);
            }
        }
        function SaveOk() {
            getOrgTreeData();
            top.Dialog.alert("保存成功！");
            //设置表单的值
            setForm("", "");
            $("#selectId").val(0);
            $("#EngineerIDs").setValue("");
            $("#ManagerIDs").setValue("");
            $("#Remark").val("");
            $("#ParentId").val(0);
            $("#Ord").val(0);

        }

        // 保存
        function Save() {
            var Obj = JSON.stringify(DepartmentObj());
            $.ajax({
                 type: 'POST',
//                 url: '../Handler/Departments.ashx',

                url: '/departments/save',
                dataType: 'text',   //预期服务器返回的数据类型

                contentType: "application/json; charset=utf-8",
                data: obj,

                //data: {
                //    Command: "Update",
                //    data: Obj
                //},
                success: function (result) {
                    if (result == "ok") {
                        SaveOk();
                    }
                },
                error: function (a) {
                    top.Dialog.alert("访问服务器端出错！");
                }
            });
        }

        // 获取科室信息
        function DepartmentObj() {
            var obj = new Object();
            obj.id = $("#selectId").val();
            obj.DeptName = escape($("#selectname").val());
            obj.ManagerID = $("#ManagerID").val();
            obj.EngineerID = $("#EngineerID").val();
            obj.Ord = $("#Ord").val();
            obj.Remark = $("#Remark").val();
            obj.NurseStationTel = $("#txtNurseStationTel").val();
            return obj;
        }

        function Set() {
            $("#selectname").val($("#hdselectname").val());
            $("#EngineerIDs").setValue($("#EngineerID").val());
            $("#ManagerIDs").setValue($("#ManagerID").val());
            $("#Remark").val($("#hdRemark").val());
            $("#Ord").val($("#hdOrd").val());
        }


        //添加节点
        function addNode(treeNode) {
            //设置表单的值
            setForm(treeNode.name, "", "", "");
            $.ajax({
//            url: '../Handler/Departments.ashx',

                url: '/departments/add',
                dataType: 'json',
                data: { Id: escape(0), DeptName: escape(treeNode.name), ParentId: escape(treeNode.parentId), Command: "Add" },
                success: function (result) {
                    getOrgTreeData();
                },
                error: function (result) {
                    getOrgTreeData();
                }
            });
        }


        //修改节点名称
        function updateNode(treeNode) {
            $.ajax({
//            url: '../Handler/Departments.ashx',

                url: '/Departments/save',
                dataType: 'json',
                data: { Id: escape(treeNode.id), DeptName: escape(treeNode.name), Command: "Edit" },
                success: function (result) {
                    if (result == "OK") {
                        getOrgTreeData();
                    } else {
                        alert("科室名称已存在！");
                        getOrgTreeData();
                    }

                },
                error: function (result) {
                    getOrgTreeData();
                }
            });
        }


        //确认是否删除+删除处理
        function beforeRemove1(treeId, treeNode) {

            if (treeNode.id != 30001) {
                if (treeNode.id == 0) {
                    top.Dialog.alert("根节点不能删除！");
                    return false;
                }
                else if (getPosition(treeNode.id, noeditArray) != -1) {
                    //top.Dialog.alert("为保证数据的完整性，由管理员添加的数据无法修改或删除。可以为新添加的数据来修改和删除。");
                    //return false;
                }
                var zTree = $.fn.zTree.getZTreeObj("tree-1");
                //选中该节点
                zTree.selectNode(treeNode);
                top.Dialog.confirm("确认删除 节点 -- " + treeNode.name + " 吗？", function () {
                    //此处进行ajax后台数据处理
                    $.ajax({
//                    url: '../Handler/Departments.ashx',

                        url: 'departments/delete',
                        dataType: 'json',
                        data: { Id: escape(treeNode.id), Command: "Del" },
                        success: function (result) {
                            getOrgTreeData();
                        },
                        error: function (result) {
                            getOrgTreeData();
                        }
                    });
                });

            }
            return false;
        }

        //添加新增按钮
        var newCount = 1;
        function addHoverDom(treeId, treeNode) {

            if (treeNode.editNameFlag || $("#addBtn_" + treeNode.id).length > 0) return;

            var sObj = $("#" + treeNode.tId + "_span");
            var addStr = "<span class='zbutton add' id='addBtn_" + treeNode.id + "' title='添加' onfocus='this.blur();'></span>";
            sObj.append(addStr);

            var btn = $("#addBtn_" + treeNode.id);
            if (btn) {
                btn.bind("click", function () {
                    var zTree = $.fn.zTree.getZTreeObj("tree-1");
                    var newNode;
                    newNode = zTree.addNodes(treeNode, { id: (100 + newCount), parentId: treeNode.id, name: "新增" + (newCount++), icon: "/assets/libs/icons/folder.gif" });
                    if (newNode) {
                        zTree.editName(newNode[0]);
                        //设置表单的值
                        setForm(newNode[0].name, "", "", "");
                    }
                    return false;
                });
            }
        };

        function removeHoverDom(treeId, treeNode) {

            $("#addBtn_" + treeNode.id).unbind().remove();

        };

        //设置表单值
        function setForm(val1, val2, val3, val4) {
            $("#selectname").val(val1 == 'null' ? '' : val1);
            $("#EngineerID").val(val2 == 'null' ? '' : val2);

        }

  
    </script>
</body>
</html>
